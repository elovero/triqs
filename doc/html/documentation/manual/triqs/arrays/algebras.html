
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Operations: array and matrix/vector algebras &#8212; TRIQS Docs</title>
    <link rel="stylesheet" href="../../../../_static/triqs2.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../../_static/triqs2.js"></script>
    <script type="text/javascript" src="../../../../_static/prism.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=default"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<link rel="stylesheet" href="https://use.typekit.net/hsv6sot.css" />
<link href="/_static/prism.css" rel="stylesheet" />
<script type="text/javascript">
  try {
    Typekit.load();
  } catch (e) {}
</script>

  </head>
<body>
  
  <header class="header">
    <nav class="header-content">
      <div class="row header-row">
        <div class="col-xs-2 logo-col">
          <div class="row start-xs">
            <div class="nav-item">
              <a class="nav-link" href="/"
                ><span class="nav-logo">TRIQS</span></a
              >
            </div>
          </div>
        </div>
        <div class="col-xs-6">
          <div class="row">
            <div class="nav-item">
              <a class="nav-link" href="/documentation.html">Docs</a>
            </div>
            <div class="nav-item">
              <a class="nav-link" href="/tutorials.html">Tutorials</a>
            </div>
            <div class="nav-item">
              <a class="nav-link" href="/applications.html">Applications</a>
            </div>
            <div class="nav-item">
              <a class="nav-link" href="/community.html">Community</a>
            </div>
          </div>
        </div>
        <div class="col-xs-4">
          <div class="row end-xs">
            <div class="nav-item">
              <a class="nav-link" href="/about.html">About</a>
            </div>
            <div class="nav-item">
              <a
                class="nav-link"
                target="_blank"
                rel="noopener noreferrer"
                href="https://github.com/TRIQS/triqs"
                >Github</a
              >
            </div>
          </div>
        </div>
      </div>
    </nav>
  </header>
    

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="operations-array-and-matrix-vector-algebras">
<h1>Operations: array and matrix/vector algebras<a class="headerlink" href="#operations-array-and-matrix-vector-algebras" title="Permalink to this headline">¶</a></h1>
<div class="section" id="arithmetic-operations">
<h2>Arithmetic operations<a class="headerlink" href="#arithmetic-operations" title="Permalink to this headline">¶</a></h2>
<p>Arrays and matrices can be combined in formal algebraic expressions, which models the <a class="reference internal" href="concepts.html#immutablecuboidarray"><span class="std std-ref">ImmutableCuboidArray</span></a> concept.
This algebraic expressions can therefore be used in assignment array/matrix contructors.
For example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;triqs/arrays.hpp&gt;</span><span class="cp"></span>
<span class="n">using</span> <span class="n">triqs</span><span class="o">::</span><span class="n">arrays</span><span class="o">::</span><span class="n">array</span><span class="p">;</span>
<span class="n">using</span> <span class="n">triqs</span><span class="o">::</span><span class="n">clef</span><span class="o">::</span><span class="n">placeholder</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// init</span>
  <span class="n">placeholder</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">i_</span><span class="p">;</span>
  <span class="n">placeholder</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">j_</span><span class="p">;</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">A</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">j_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i_</span> <span class="o">+</span> <span class="n">j_</span><span class="p">;</span>
  <span class="n">B</span><span class="p">(</span><span class="n">i_</span><span class="p">,</span> <span class="n">j_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i_</span> <span class="o">-</span> <span class="n">j_</span><span class="p">;</span>

  <span class="c1">// use expressions</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">C</span>   <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B</span><span class="p">;</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">D</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">A</span><span class="p">;</span> <span class="c1">// Type promotion is automatic</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;B= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;C= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">C</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;D= &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">D</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="arrays-vs-matrices">
<h2>Arrays vs matrices<a class="headerlink" href="#arrays-vs-matrices" title="Permalink to this headline">¶</a></h2>
<p>Because their multiplication is not the same, arrays and matrices algebras cannot be mixed.
Mixing them in expression would therefore be meaningless and it is therefore not allowed.
However, you can always use e.g. <cite>matrix_view</cite> from a array of rank 2 :</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;triqs/arrays.hpp&gt;</span><span class="cp"></span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">triqs</span><span class="o">::</span><span class="n">arrays</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">matrix</span><span class="o">&lt;</span><span class="kt">long</span><span class="o">&gt;</span> <span class="n">M</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="c1">// M + A; // --&gt; ERROR. Rejected by the compiler.</span>
  <span class="n">M</span> <span class="o">+</span> <span class="n">make_matrix_view</span><span class="p">(</span><span class="n">A</span><span class="p">);</span> <span class="c1">//--&gt; OK.</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Making such a view is very cheap, it only copies the index systems. Nevertheless
this can still cause significant overhead in very intense loops by disturbing
optimizers.</p>
</div>
</div>
<div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>The performance of such compact writing is as good as “hand-written” code or even better.</p>
<p>Indeed, the operations are implemented with the <cite>expression templates</cite> technique.
The principle is that the result of A+B is <strong>NOT</strong> an array, but a more complex type which stores
the expression using the naturally recursive structure of templates.</p>
<p>Expressions models <a class="reference internal" href="concepts.html#immutablecuboidarray"><span class="std std-ref">ImmutableCuboidArray</span></a> concept.
They behave like an immutable array: they have a domain, they can be evaluated.
Hence they can used <em>anywhere</em> an object modeling this concept is accepted, e.g.:</p>
<ul class="simple">
<li><p>array, matrix contruction</p></li>
<li><p>operator =, +=, -=, …</p></li>
</ul>
<p>When an array in assigned (or constructed from) such expression, it fills itself
by evaluating the expression.</p>
<p>This technique allows the elimination of temporaries, so that the clear and readable code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Z</span><span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">B</span> <span class="o">+</span> <span class="n">C</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</pre></div>
</div>
<p>is in fact rewritten by the compiler into</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,...)</span> <span class="n">indices</span> <span class="n">of</span> <span class="n">A</span><span class="p">,</span> <span class="nl">B</span> <span class="p">:</span>
  <span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span> <span class="n">B</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
<p>instead of making a chain of temporaries (C/2, 2*B, 2*B + C/2…) that “ordinary” object-oriented programming would produce.
As a result, the produced code is as fast as if you were writing the loop yourself,
but with several advantages:</p>
<ul class="simple">
<li><p>It is more <strong>compact</strong> and <strong>readable</strong>: you don’t have to write the loop, and the indices range are computed automatically.</p></li>
<li><p>It is much better for <strong>optimization</strong>:</p>
<ul>
<li><p>What you want is to tell the compiler/library to compute this expression, not <em>how</em> to do it optimally on a given machine.</p></li>
<li><p>For example, since the traversal order of indices is decided at compile time, the library can traverse the data
in an optimal way, allowing machine-dependent optimization.</p></li>
<li><p>The library can perform easy optimisations behind the scene when possible, e.g. for vector it can use blas.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="expressions-are-lazy">
<h2>Expressions are lazy….<a class="headerlink" href="#expressions-are-lazy" title="Permalink to this headline">¶</a></h2>
<p>Note that expressions are lazy objects. It does nothing when constructed, it just “record” the mathematical expression</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span> <span class="n">e</span> <span class="o">=</span>  <span class="n">A</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">B</span><span class="p">;</span>             <span class="c1">// expression, purely formal, no computation is done</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">e</span> <span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>              <span class="c1">// prints the expression</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>         <span class="c1">// evaluates just at a point</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">domain</span><span class="p">()</span> <span class="o">&lt;&lt;</span><span class="n">endl</span> <span class="p">;</span>     <span class="c1">// just computes its domain</span>
<span class="n">array</span><span class="o">&lt;</span><span class="kt">long</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span> <span class="n">D</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>            <span class="c1">// now really makes the computation and store the result in D.</span>
<span class="n">D</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">A</span> <span class="o">+</span><span class="n">B</span><span class="p">;</span>                    <span class="c1">// reassign D to the evaluation of the expression.</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sidebar">
  <div class="container-fluid sidebar-container">
      <div class="row sidebar-row">
        
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../capiref.html">C++ API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pythonapiref.html">Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../community.html">Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faqs.html">FAQS</a></li>
</ul>

        
      </div>
      <div class="row sidebar-row search-row">
        <div
          class="sidebar-section"
          id="searchbox"
          style="display: none"
          role="search"
        >
          <div class="sidebar-header">
            <a class="sidebar-header-link">Quick search</a>
          </div>
        </div>
        <div class="searchformwrapper">
          <form class="search" action="../../../../search.html" method="get">
            <input type="text" name="q" aria-labelledby="searchlabel" />
            <input type="submit" value="Go" />
          </form>
        </div>
        <script type="text/javascript">
          $("#searchbox").show(0);
        </script>
      </div>
    </div>
  </div>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <footer>
    <div class="container-fluid">
      <div class="row footer">
        <div class="col-xs-12 center-xs middle-xs">
          <div class="outro">
            <p class="footer-description">
              TRIQS (Toolbox for Research on Interacting Quantum Systems) is a
              scientific project providing a set of C++ and Python libraries to
              develop new tools for the study of interacting quantum systems
              based at the Center for Computational Quantum Physics at the
              Flatiron Institute.
            </p>
          </div>
          <ul class="footer-links">
            <li class="footer-link">
              <a exact="true" href="/about.html">About</a>
            </li>
            <li class="footer-link">
              <a
                target="_blank"
                rel="noopener noreferrer"
                href="https://simonsfoundation.org"
                >Simons Foundation</a
              >
            </li>
            <li class="footer-link">
              <a
                target="_blank"
                rel="noopener noreferrer"
                href="https://flatironinstitute.org"
                >Flatiron Institute</a
              >
            </li>
            <li class="footer-link"><a exact="true" href="/">Github</a></li>
            <li class="footer-link">
              <a exact="true" href="/contact">Contact</a>
            </li>
          </ul>
          <p class="updated">Updated on January 20, 2020 (2:20pm)</p>
        </div>
      </div>
    </div>
  </footer>
  
  </body>
</html>